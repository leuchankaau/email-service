# Email-service Architecture 
## Summary
Main idea of this sevice arhtitecture to take responsability for email delivery, to allow other componets reduce error handling coplexity in case of failed email.
Other approach can be if email delivery fails delivere thorugh other email provider or chanells(e.g. sms or post). 
Arhitecture uses servless patter with use of AWS API Gateway, Lambda and SQS. 
 Serless Arhitecture with API gateway allows to build decoupled solution without overhead of managing garunteed delivery thorugh database or other sources. 
 
 **The diagram have 3 flows:**
 * [1.1-1.3 Accepting message for processing](#Accepting-message-for-processing) 
 * [2.1-2.4 and 3.1-3.4 Processing message by providers](#Processing-message-by-providers) 
 * [E.1-E.3 Failed Delivery Handling](#Failed-Delivery-Handling) 
 
[**Decisions**](#Decisions)
 
[ **New Provider**](#New-Provider) 
 
![alt text](https://github.com/leuchankaau/email-service/blob/master/EmailService.png)

## Accepting message for processing
API Gateway accepts message and validate according to schema. 
2 choices possible fro API validation implment it in lambda or in API Gateway.
API Gateway input validation can be generated based on Open API standart, which can be generated by Swagger, which is a plus vecose we can make sure that technical validatio is aligned with contect.
More complex validation would be done lamda.

Lamda also takes responsability of routing between providers, there is a bit of mix concerns ideally we want to sepaate this things, but for simplity purpuse and lack of special rules validation we can keep it as is.

Lamda routes message based on evirement variables between providers queues. Load balancer can also be used for routing and would be much more elegant, but we avoid it to reduce complexity.

## Processing message by providers
Message pulled by lambda and sent to provider, if succesull response acknowledge delivery, if error push back to qeueu and retry in time configure in queue.After several retries queue will push it to DLQ.
## Failed Delivery Handling
Pull message from Provider error queues, update with info that it failed for provider and push it to another provider, if all providers failed then forward it to error for manual handling. 
## Decisions
1. Servless vs standart microservice
2. API Gateway input validation vs Lambda validation.
3. Load balancer vs Lambda router.
4. Tracking current status of message in DB - not implmented as of now
5. Storing vs not storing content of message in DB  - not implmented as of now
6. Lamda for monitoring and notfication in case if error queue get messages - not implmented as of now
## New Provider
You need to complete **3 steps** to add new provider:
1. Implment prrovider flow with SQS and DLQ for provider message, and lambda integration component.
2. **Update Failed Delivery handling** to add new provider message, otherwise infinite error message can start generate **huge cost**.
3. Change router to enable routing between 3 providers  
